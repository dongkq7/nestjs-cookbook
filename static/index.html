<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>扫码登录</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/axios@1.5.0/dist/axios.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .login-container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        padding: 40px;
        max-width: 400px;
        width: 100%;
        text-align: center;
        animation: slideUp 0.5s ease-out;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .logo {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        border-radius: 50%;
        margin: 0 auto 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        font-weight: bold;
      }

      h1 {
        color: #333;
        font-size: 24px;
        margin-bottom: 10px;
        font-weight: 600;
      }

      .subtitle {
        color: #666;
        font-size: 16px;
        line-height: 1.6;
        margin-bottom: 30px;
      }

      .qrcode-container {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        border: 2px dashed #e9ecef;
        transition: all 0.3s ease;
      }

      .qrcode-container.loading {
        background: linear-gradient(
          90deg,
          #f8f9fa 25%,
          #e9ecef 50%,
          #f8f9fa 75%
        );
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
      }

      @keyframes loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      #qrcode-img {
        width: 200px;
        height: 200px;
        border-radius: 8px;
        transition: opacity 0.3s ease;
      }

      #qrcode-img.loading {
        opacity: 0.5;
      }

      .status-container {
        margin: 25px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 12px;
        border-left: 4px solid #667eea;
      }

      .status-title {
        color: #333;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .status-content {
        color: #666;
        font-size: 16px;
        font-weight: 500;
        min-height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .status-icon {
        font-size: 18px;
      }

      .status-no-scan {
        color: #666;
      }
      .status-scan-wait-confirm {
        color: #ffa500;
      }
      .status-scan-confirm {
        color: #28a745;
      }
      .status-scan-cancel {
        color: #dc3545;
      }

      .steps {
        display: flex;
        justify-content: space-between;
        margin: 30px 0;
        position: relative;
      }

      .steps::before {
        content: '';
        position: absolute;
        top: 15px;
        left: 30px;
        right: 30px;
        height: 2px;
        background: #e9ecef;
        z-index: 1;
      }

      .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 2;
      }

      .step-circle {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #e9ecef;
        color: #666;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
        transition: all 0.3s ease;
      }

      .step.active .step-circle {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
      }

      .step.completed .step-circle {
        background: #28a745;
        color: white;
      }

      .step-text {
        font-size: 12px;
        color: #666;
        text-align: center;
      }

      .step.active .step-text {
        color: #667eea;
        font-weight: 600;
      }

      .security-info {
        margin-top: 25px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        font-size: 14px;
        color: #888;
      }

      .security-icon {
        color: #28a745;
        font-weight: bold;
        margin-right: 5px;
      }

      .loading-dots {
        display: inline-flex;
        gap: 4px;
      }

      .loading-dots span {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #667eea;
        animation: dot-pulse 1.5s infinite ease-in-out;
      }

      .loading-dots span:nth-child(2) {
        animation-delay: 0.2s;
      }
      .loading-dots span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes dot-pulse {
        0%,
        60%,
        100% {
          transform: scale(1);
          opacity: 0.5;
        }
        30% {
          transform: scale(1.5);
          opacity: 1;
        }
      }

      /* 响应式设计 */
      @media (max-width: 480px) {
        .login-container {
          padding: 30px 20px;
          margin: 10px;
        }

        h1 {
          font-size: 20px;
        }

        .subtitle {
          font-size: 14px;
        }

        #qrcode-img {
          width: 180px;
          height: 180px;
        }

        .steps {
          margin: 20px 0;
        }

        .step-text {
          font-size: 11px;
        }
      }
    </style>
  </head>
  <body>
    <div class="login-container">
      <div class="logo">📱</div>

      <h1>扫码登录</h1>

      <div class="subtitle">使用手机扫描二维码，安全快捷登录</div>

      <div class="qrcode-container loading" id="qrcodeContainer">
        <img id="qrcode-img" src="" alt="登录二维码" class="loading" />
      </div>

      <div class="steps">
        <div class="step active" id="step1">
          <div class="step-circle">1</div>
          <div class="step-text">打开App</div>
        </div>
        <div class="step" id="step2">
          <div class="step-circle">2</div>
          <div class="step-text">扫描二维码</div>
        </div>
        <div class="step" id="step3">
          <div class="step-circle">3</div>
          <div class="step-text">确认登录</div>
        </div>
      </div>

      <div class="status-container">
        <div class="status-title">登录状态</div>
        <div class="status-content" id="statusContent">
          <div class="loading-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
          正在加载二维码...
        </div>
      </div>

      <div class="security-info">
        <span class="security-icon">🔒</span>
        二维码每5分钟自动更新，请勿分享给他人
      </div>
    </div>

    <script>
      let currentQrCodeId = '';

      // 获取二维码
      function generateQrCode() {
        const qrcodeContainer = document.getElementById('qrcodeContainer');
        const qrcodeImg = document.getElementById('qrcode-img');
        const statusContent = document.getElementById('statusContent');

        // 显示加载状态
        qrcodeContainer.classList.add('loading');
        qrcodeImg.classList.add('loading');
        statusContent.innerHTML =
          '<div class="loading-dots"><span></span><span></span><span></span></div>正在生成二维码...';

        axios
          .get('http://localhost:3000/qrcode-login/generate')
          .then((res) => {
            qrcodeImg.src = res.data.img;
            currentQrCodeId = res.data.qrcode_id;

            // 移除加载状态
            qrcodeContainer.classList.remove('loading');
            qrcodeImg.classList.remove('loading');

            // 开始轮询状态
            queryStatus(currentQrCodeId);
          })
          .catch((error) => {
            console.error('获取二维码失败:', error);
            statusContent.innerHTML =
              '<span class="status-icon">❌</span><span class="status-scan-cancel">二维码生成失败，请刷新页面重试</span>';
            qrcodeContainer.classList.remove('loading');
          });
      }

      // 轮询检查二维码状态
      function queryStatus(id) {
        axios
          .get(`http://localhost:3000/qrcode-login/check?id=${id}`)
          .then((res) => {
            const status = res.data.status;
            updateStatusDisplay(status, res.data);

            if (status === 'no-scan' || status === 'scan-wait-confirm') {
              setTimeout(() => queryStatus(id), 1000);
            } else if (status === 'scan-cancel') {
              // 取消后重新生成二维码
              setTimeout(() => generateQrCode(), 2000);
            }
          })
          .catch((error) => {
            console.error('查询状态失败:', error);
            setTimeout(() => queryStatus(id), 2000);
          });
      }

      // 更新状态显示
      function updateStatusDisplay(status, data) {
        const statusContent = document.getElementById('statusContent');
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');

        let content = '';
        let statusClass = '';

        switch (status) {
          case 'no-scan':
            content =
              '<span class="status-icon">📱</span><span class="status-no-scan">等待扫码</span>';
            statusClass = 'status-no-scan';
            step1.classList.add('active');
            step2.classList.remove('active', 'completed');
            step3.classList.remove('active', 'completed');
            break;
          case 'scan-wait-confirm':
            content =
              '<span class="status-icon">👆</span><span class="status-scan-wait-confirm">已扫码，请在手机上确认</span>';
            statusClass = 'status-scan-wait-confirm';
            step1.classList.add('completed');
            step2.classList.add('active');
            step3.classList.remove('active', 'completed');
            break;
          case 'scan-confirm':
            content =
              '<span class="status-icon">✅</span><span class="status-scan-confirm">登录成功！正在跳转...</span>';
            statusClass = 'status-scan-confirm';
            step1.classList.add('completed');
            step2.classList.add('completed');
            step3.classList.add('completed');
            // 登录成功后的跳转逻辑
            setTimeout(() => {
              window.location.href = `/pages/welcome.html?userId=${data.userId}&userName=${data.userName}&token=${data.token}`; // 修改为实际的跳转地址
            }, 1500);
            break;
          case 'scan-cancel':
            content =
              '<span class="status-icon">❌</span><span class="status-scan-cancel">已取消，重新生成二维码...</span>';
            statusClass = 'status-scan-cancel';
            step1.classList.remove('active', 'completed');
            step2.classList.remove('active', 'completed');
            step3.classList.remove('active', 'completed');
            break;
        }

        statusContent.innerHTML = content;
      }

      // 页面加载完成后生成二维码
      document.addEventListener('DOMContentLoaded', function () {
        generateQrCode();
      });

      // 二维码点击重新生成
      document
        .getElementById('qrcode-img')
        .addEventListener('click', function () {
          if (this.complete && this.naturalWidth > 0) {
            generateQrCode();
          }
        });
    </script>
  </body>
</html>
